---
title: "map test"
output: html_document
date: "2023-11-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}

library("tidyverse")
library("sf")
library("patchwork")
library("rnaturalearth")
library("rnaturalearthdata")
library("RColorBrewer")
library("ggh4x")
library("adespatial")
library("scales")
library("here")

```

```{r load data}

if (Sys.info()["sysname"] == "Darwin") {
  preds <- read.csv(here("data/allpopulations.csv"))
  est <- read.csv(here("data/atoll_seabird_global_popestimates.csv"))
  envs <- read.csv(here("data/seabird_atolls_envs.csv"))
  nest <- read.csv(here("data/seabird_filterconditions.csv"))
  raw <- read.csv(here("data/atoll_seabird_populations.csv"))
} else {
  preds <- read.csv("C:/Users/sebas/OneDrive/Dokumente/GitHub/atoll-seabirds/data/allpopulations.csv")
  est <- read.csv("C:/Users/sebas/OneDrive/Dokumente/GitHub/atoll-seabirds/data/atoll_seabird_global_popestimates.csv")
  envs <- read.csv("C:/Users/sebas/OneDrive/Dokumente/GitHub/atoll-seabirds/data/seabird_atolls_envs.csv")
  nest <- read.csv("C:/Users/sebas/OneDrive/Dokumente/GitHub/atoll-seabirds/data/seabird_filterconditions.csv")
  # Don't load after allpop fix
  raw <- read.csv("C:/Users/sebas/OneDrive/Dokumente/GitHub/atoll-seabirds/data/atoll_seabird_populations.csv")
}

# turn into factors
envs <- envs %>% select(atoll, region, lat, long) %>% mutate(across(1:2, as.factor))
preds <- preds %>% select(atoll, species, nbirds) %>% mutate(across(1:2, as.factor))
nest <- nest %>% select(species, nestingtype, group, bodymass) %>% mutate(across(1:3, as.factor))

# turn predicted abundances into whole numbers
preds$nbirds <- round(preds$nbirds,0)

# convert longitudes for 'sf' format
envs$long <- ifelse(envs$long < 0, envs$long+360, envs$long)


###########################################################
# --- IRRELEVANT ONCE ERROR IN ALLPOPULATIONS IS FIXED ----
###########################################################

raw$atoll <- as.factor(raw$atoll)

# long format
raw.long <- raw %>%  pivot_longer(cols = !atoll, names_to = "species", values_to = "nbirds", 
                                  values_drop_na = TRUE) %>% 
                    filter(nbirds > 0)

# temp
temp <- rbind(raw.long, preds) %>% distinct(atoll, species, .keep_all = TRUE) %>% as.data.frame()
temp <- temp[order(temp$atoll),] # sort alphabetically by atolls

rm(raw)
rm(raw.long)

#############################################################
```


```{r prepare data frames for plotting}

# add 'empty' atolls to count pred data frame

# replace temp here with preds once error fixes
dat <- left_join(envs, temp, by = "atoll") %>% mutate(nbirds = replace_na(nbirds, 0))

# convert long format into atoll x species matrix for beta-diversity computation
matrix <- dat %>% pivot_wider(names_from = species, values_from = nbirds, values_fill = 0) %>% 
                    select(!"NA") %>% as.data.frame()
rm(dat) # no longer needed, keep tidy


# calculate local contribution to beta diversity (LCBD) [and species contribution to beta diversity (SCBD)]
beta.atoll <- matrix[c(which(rowMeans(matrix[,-c(1:4)]) > 0)),-c(1:4)] %>% 
                beta.div(., method = "percentdiff", sqrt.D = TRUE, samp = FALSE)
beta <- beta.atoll$LCBD %>% as.data.frame()
beta$atoll <- matrix[c(which(rowMeans(matrix[,-c(1:4)]) > 0)),]$atoll
colnames(beta)[1] <- "lcbd"
rm(beta.atoll) # no longer needed, keep tidy

# Richness differences and species turnover
comp.atoll <- matrix[c(which(rowMeans(matrix[,-c(1:4)]) > 0)),-c(1:4)] %>% beta.div.comp(., coef = "J", quant = FALSE)


# add seabird metadata and calculate atoll-wise biomass per species
comb <- matrix %>% pivot_longer(!c(atoll, region, lat, long), names_to = "species", values_to = "nbirds")
comb$species <- as.factor(comb$species)
comb <- comb %>% left_join(., nest, by = "species") %>% as.data.frame()

comb$biomass <- comb$nbirds*comb$bodymass
comb <- comb %>% select(!c(bodymass,nestingtype))


# summarize atoll-wise
atoll <- comb %>% group_by(atoll, region, lat, long) %>% summarise(nspec = sum(nbirds > 0),
                                                         nbirds = sum(nbirds),
                                                         totbiomass = sum(biomass)) %>% as.data.frame()

atoll <- atoll %>% left_join(., beta, by = "atoll") %>% mutate(lcbd = replace_na(lcbd, 0))


# summarize species-wise
spec <- comb %>% group_by(species, group) %>% summarise(nbirds = sum(nbirds),
                                                 totbiomass = sum(biomass)) %>% as.data.frame() 

# calculate proportion contribution to global population
spec <- left_join(spec, est, by = "species")

spec$ratios <- ifelse(is.na(spec$Callaghan) == FALSE, spec$nbirds*1/spec$Callaghan,
            ifelse(is.na(spec$HBW) == FALSE, spec$nbirds*1/spec$HBW, 
              ifelse(is.na(spec$birdlife_max) == TRUE, spec$nbirds*1/spec$birdlife_min,
                      spec$nbirds*1/spec$birdlife_max)))

spec <- spec %>% select(c(species, group, nbirds, totbiomass, ratios))
spec$species <- as.factor(spec$species)

########################################################################### 
############## --- TEMPORARY!!! NEED FIX IN DATA --- ######################
spec[which(spec$species == "Nesofregetta_fuliginosa"),]$ratios  <- 0.99
###########################################################################

```


```{r base map}
mapWorld <- ne_countries(scale = "medium", returnclass = "sf")
mapCoast <- ne_coastline(scale = "medium", returnclass = "sf")

# create map layer
map <- ggplot() + 
  geom_sf(data = mapWorld, fill = "#EBE3D5", color = NA) +
  geom_sf(data = mapCoast, linewidth = 0.15) +
  coord_sf(xlim = c(46.5, 255),
           ylim = c(-30, 30)) +
  theme_classic() +
  geom_segment(aes(x = 36.2, xend = 36.2, y = -30.1, yend = 30.1), linewidth = 0.8) +
  geom_segment(aes(x = 49.9, xend = 250.1, y = -33, yend = -33), linewidth = 0.8) +
  theme(
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.text = element_text(size = 11),
    axis.ticks = element_line(linewidth = 0.8),
    title = element_text(size = 13),
    legend.text = element_text(size = 9),
    legend.background = element_rect(color = "black", fill = "white"))

# set up base structure aesthetics for boxplots
boxplotaesth <- theme_classic() +
                theme(
                    legend.position = "none",
                    axis.title.x = element_blank(),
                    axis.ticks.x = element_blank(),
                    axis.text.x = element_blank(),
                    axis.text.y = element_text(size = 11),
                    axis.title.y = element_text(size = 12)
                    )

```

```{r abundance and richness}

# total bird numbers 
spat.1a <- atoll %>% arrange(nbirds) %>%  st_as_sf(., coords = c("long", "lat"), crs = 4326)
coords.1a <- spat.1a %>% st_coordinates(extract())

p1a <- map + 
  geom_point(data = spat.1a,
             aes(x = coords.1a[,1], y = coords.1a[,2], colour = log10(nbirds+1)), 
             size = 1.1, shape = 21, alpha = 0.9, stroke = 1.9) +
  scale_colour_gradientn(colours = c("#fbe725", "#3dbc74", "#306b84","black"),
                         values = c(1.0, 0.5, 0.1, 0),
                         name = "log(abundance)") +
  ggtitle("a. population size") +
  theme(legend.position = "none")

# species richness
spat.2a <- atoll %>% arrange(nspec) %>%  st_as_sf(., coords = c("long", "lat"), crs = 4326)
coords.2a <- spat.2a %>% st_coordinates(extract())

p2a <- map + 
  geom_point(data = spat.2a,
             aes(x = coords.2a[,1], y = coords.2a[,2], colour = nspec), 
             size = 1.1, shape = 21, alpha = 0.9, stroke = 1.9) +
  scale_colour_gradientn(colours = c("#fbe725", "#3dbc74", "#306b84","black"),
                         values = c(1.0, 0.3, 0.05, 0),
                         name = "Species richness") +
  ggtitle("b. diversity") +
  theme(legend.position = "none")

# dissimilarity
spat.3a <- atoll %>% st_as_sf(., coords = c("long", "lat"), crs = 4326)
coords.3a <- spat.3a %>% st_coordinates(extract())

p3a <- map +
  geom_point(data = spat.3a,
             aes(x = coords.3a[,1], y = coords.3a[,2], colour = lcbd),
             size = 1.1, shape = 21, alpha = 0.9, stroke = 1.9) +
   scale_colour_gradientn(colours = c("#fbe725", "#3dbc74", "#306b84","black"),
                         values = c(1, 0.65, 0.001, 0),
                         name = "LCBD") +
  ggtitle("c. compositional distinctness of atolls") +
  theme(legend.position = "none")


# boxplot abundance
p1b <- ggplot(data = atoll[which(atoll$nbirds > 0), ], aes(x = "identity", y = nbirds)) +
  geom_violin(fill = "#EBEBEB", alpha = 0.5) +
  geom_jitter(aes(colour = log(nbirds+1)), width = 0.15, size = 1.5) +
  geom_boxplot(fill = "#EBEBEB", width = 0.1, alpha = 0.5, outlier.shape = NA) +
  scale_y_continuous(trans = "log",
                     breaks = c(10, 100, 1000, 10000, 100000, 1000000, 10000000),
                     labels = scales::comma) +
  scale_colour_gradientn(colours = c("#fbe725", "#3dbc74", "#306b84","black"),
                         values = c(1.0, 0.5, 0.1, 0)) +
  guides(x = "axis_truncated", y = guide_axis_truncated(trunc_lower = 10, trunc_upper = 1000000)) +
  ylab("abundance") +
  geom_hline(yintercept = 13200, linetype = "dotted", linewidth = 0.5) + 
  annotate("text", label = "B3b (A4iii)", x = 1.4, y = 25000, size = 3, fontface = "italic") +
  boxplotaesth

# boxplot richness
p2b <- ggplot(data = atoll, aes(x = "identity", y = nspec)) +
  geom_violin(fill = "#EBEBEB", alpha = 0.5) +
  geom_jitter(aes(colour = nspec), width = 0.15, size = 1.5) +
  geom_boxplot(fill = "#EBEBEB", width = 0.1, alpha = 0.5, outlier.shape = NA) +
  scale_colour_gradientn(colours = c("#fbe725", "#3dbc74", "#306b84","black"),
                         values = c(1.0, 0.3, 0.05, 0)) +
  scale_y_continuous(breaks = c(0, 5, 10, 15, 19)) +
  guides(x = "axis_truncated", y = guide_axis_truncated(trunc_lower = 0, trunc_upper = 19)) +
  ylab("species richness") +
  boxplotaesth

# boxplot lcbd
p3b <- ggplot(data = atoll[which(atoll$nbirds > 0), ], aes(x = "identity", y = lcbd)) +
  geom_violin(fill = "#EBEBEB", alpha = 0.5) +
  geom_jitter(aes(colour = lcbd), width = 0.15, size = 1.5) +
  geom_boxplot(fill = "#EBEBEB", width = 0.1, alpha = 0.5, outlier.shape = NA) +
  scale_colour_gradientn(colours = c("#fbe725", "#3dbc74", "#306b84","black"),
                         values = c(1, 0.65, 0.001, 0)) +
  scale_y_continuous(breaks = c(0.0026, 0.0037, 0.0048, 0.0059)) +
  guides(x = "axis_truncated", y = guide_axis_truncated(trunc_lower = 0.0026, trunc_upper = 0.0059)) +
  ylab("LCBD") +
  boxplotaesth

pmapbox <- p1a+p1b+p2a+p2b+p3a+p3b+plot_layout(widths = c(3,1,3,1,3,1), nrow = 3, ncol = 2)

ggsave(pmapbox, filename = "fig_pop-ric-lcbd.svg", dpi = 300, width = 210, height = 170, units = "mm")

```


```{r heatmap}
# heatmap
n <- atoll$nspec

temp <- data.frame()
long <- data.frame()

for (i in seq_along(n)) {
  temp <- atoll[rep(i, n[i]),]
  long <- rbind(long, temp)
}

long.spat <- st_as_sf(long, coords = c("long", "lat"), crs = 4326)
long.coords <- long.spat %>% st_coordinates(extract())

palette <- c("transparent", brewer.pal(n = 9, "YlOrRd"))

map +
  geom_density_2d_filled(data = long.spat,
                         aes(x = long.coords[,1], y = long.coords[,2]),
                         bins = 10) +
    geom_point(data = long.spat,
             aes(x = long.coords[,1], y = long.coords[,2]), 
             size = 1.5, alpha = 0.5) +
  scale_fill_manual(values = palette) +
  ggtitle("Heatmap seabird species richness") +
  theme(legend.position = "none")

```


```{r bird populations}
seabirdnames <- spec[,1] %>% as.data.frame()
colnames(seabirdnames) <- "species"
seabirdnames$common.names <- c("Blue-grey Noddy", "Black Noddy", "Brown Noddy", "Lesser Noddy",
                               "Wedge-Tailed Shearwater", "Bulwer's Petrel", "Lesser Frigatebird", "Great Frigatebird",
                               "White Tern", "Tristram's Storm-Petrel", "Caspian Tern", "Polynesian Storm-Petrel",
                               "Bridled Tern", "Sooty Tern", "Grey-backed Tern", "White-tailed Tropicbird", 
                               "Red-tailed Tropicbird", "Short-tailed Albatross", "Laysan Albatross", 
                               "Black-footed Albatross", "Phoenix Petrel", "Herald Petrel", "Bonin Petrel",
                               "Kermadec Petrel", "Murphy's Petrel", "Tropical Shearwater", "Christmas Shearwater",
                               "Roseate Tern", "Black-naped Tern","Australian Fairy Tern", "Saunder's Tern",
                               "Masked Booby", "Nazca Booby", "Brown Booby", "Red-footed Booby", "Great Crested Tern",
                               "Lesser Crested Tern") %>%   
                                  as.factor()
  
spec <- left_join(spec, seabirdnames, by = "species")

p11 <- ggplot(data = spec, aes(x = ratios*100, y = reorder(common.names, ratios), fill = group)) +
            geom_bar(stat = "identity", color = "black", width = 0.8, linewidth = 0.5) +
            annotate("rect", xmin = 25, xmax = 50, ymin = 0, ymax = 36, fill = "#eeeeee") +
            annotate("rect", xmin = 50, xmax = 75, ymin = 0, ymax = 36, fill = "#dddddd") +
            annotate("rect", xmin = 75, xmax = 95, ymin = 0, ymax = 36, fill = "#cccccc") +
            annotate("rect", xmin = 95, xmax = 100, ymin = 0, ymax = 36, fill = "#bbbbbb") +
            geom_bar(stat = "identity", color = "black", width = 0.8, linewidth = 0.5) +
            scale_fill_viridis_d(aesthetics = "fill", option = "mako") +
              guides(x = "axis_truncated", y = "axis_truncated", 
                   fill = guide_legend(byrow = TRUE)) +
            xlab("% of global population") +
            theme_classic() +
            theme(
              axis.title.y = element_blank(),
              axis.line.y = element_blank(),
              axis.ticks.y =element_blank(),
              axis.text.y = element_text(margin = margin(r = -8), size = 10), 
              axis.text.x = element_text(size = 11),
              axis.title.x = element_text(size = 12),
              legend.title = element_blank(),
              legend.position = c(0.7, 0.2),
              legend.text = element_text(size = 9),
              legend.spacing.y = unit(1, "mm"))

  
ggsave(p11, filename = "fig_proportion_species_global.svg", dpi = 300, width = 105, height = 150, units = "mm")

```


```{r atoll properties region stratified}

ggplot(data = atoll[which(atoll$nbirds > 0), ], aes(x = region, y = nbirds)) +
  geom_violin(aes(fill = region)) +
  geom_boxplot(aes(fill = region), width = 0.1) +
  geom_jitter(width = 0.15, size = 1.5) +
  scale_y_continuous(trans = "log",
                     breaks = c(10, 100, 1000, 10000, 100000, 1000000, 10000000),
                     labels = scales::comma) +
  scale_x_discrete(labels = c("Indian Ocean", 
                              "Melanesia",
                              "Micronesia",
                              "Polynesia")) +
  scale_fill_manual(values = c("#B5D5C5", "#B08BBB", "#ECA869", "#F5F5DC")) +
  guides(x = "axis_truncated", y = guide_axis_truncated(trunc_lower = 10, trunc_upper = 1000000)) +
  ggtitle("Population size per atoll") +
  ylab("no. of seabirds") +
  geom_hline(yintercept = 13200, linetype = "dashed", linewidth = 0.8) + 
  annotate("text", label = "B3b (A4iii) threshold)", x = 4.35, y = 18500, size = 5, fontface = "italic") +
  theme_classic() +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text = element_text(size = 13),
    axis.title.y = element_text(size = 15),
    title = element_text(size = 17))


ggplot(data = atoll, aes(x = region, y = nspec)) +
  geom_violin(aes(fill = region)) +
  geom_boxplot(aes(fill = region), width = 0.1) +
  geom_jitter(width = 0.15, size = 1.5) +
  scale_x_discrete(labels = c("Indian Ocean", 
                              "Melanesia",
                              "Micronesia",
                              "Polynesia")) +
  scale_fill_manual(values = c("#B5D5C5", "#B08BBB", "#ECA869", "#F5F5DC")) +
  guides(x = "axis_truncated", y = "axis_truncated") +
  ggtitle("Diversity of atolls") +
  ylab("no. of seabirds species") +
  theme_classic() +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text = element_text(size = 13),
    axis.title.y = element_text(size = 15),
    title = element_text(size = 17))
  
```

```{r significant breeding sites}

atollw <- left_join(comb, est, by = "species")

atollw$ratios <- ifelse(is.na(atollw$Callaghan) == FALSE, atollw$nbirds*1/atollw$Callaghan,
            ifelse(is.na(atollw$HBW) == FALSE, atollw$nbirds*1/atollw$HBW, 
              ifelse(is.na(atollw$birdlife_max) == TRUE, atollw$nbirds*1/atollw$birdlife_min,
                      atollw$nbirds*1/atollw$birdlife_max)))

atollw$species <- as.factor(atollw$species)

atollw <- atollw %>% select(!c(biomass, birdlife_min, birdlife_max, HBW, Callaghan))

# subset only for largest value per atoll
atollmax <- atollw %>% group_by(atoll, lat, long) %>% summarise(ratios = max(ratios)) %>% as.data.frame()
atollmax$cuts <- cut(atollmax$ratios,
                   breaks = c(0, 0.01, 0.10, 0.25, 0.50, 0.70, 1),
                   labels = c("<1%", "1-10%", "10-25%", "25-50%", "50-70%", ">70%"))

atollmax[is.na(atollmax$cuts),]$cuts <- "<1%"

atollmax <- atollmax %>% arrange(cuts)

spatw <- st_as_sf(atollmax, coords = c("long", "lat"), crs = 4326)

coordsw <- spatw %>% st_coordinates(extract())

p10 <- map +
  geom_point(data = spatw,
             aes(x = coordsw[,1], y = coordsw[,2], colour = cuts), 
             size = 1.1, shape = 21, alpha = 0.9, stroke = 1.9) +
  scale_colour_manual(values = c("#ECEE81","#7ED7C1", "#BEADFA", "#DC8686", "#B06161", "#D10015")) +
  ggtitle("Single atoll contribution to global populations") +
  theme(
    legend.title = element_blank())

ggsave(p10, filename = "fig_atollwise_contribution_atoll_glob_NO-ICONS.svg",
       dpi = 300, width = 210, height = 100, units = "mm")

```

```{r species heatmaps}

spatspec <- st_as_sf(atollw, coords = c("long", "lat"), crs = 4326)

coordspec <- spatspec %>% st_coordinates(extract())

palette <- c("transparent", brewer.pal(n = 9, "YlOrRd"))

targetspec <- c("Anous_ceruleus")

map +
  geom_density_2d_filled(data = spatspec[which(spatspec$species == targetspec),],
                         aes(x = coordspec[which(spatspec$species == targetspec),1], 
                             y = coordspec[which(spatspec$species == targetspec),2]),
                         bins = 10) +
    geom_point(data = spatspec[which(spatspec$species == targetspec),],
                         aes(x = coordspec[which(spatspec$species == targetspec),1], 
                             y = coordspec[which(spatspec$species == targetspec),2]),
             size = 2.5, alpha = 0.5) +
  scale_fill_manual(values = palette) +
  ggtitle(targetspec) +
  theme(legend.position = "none")

```

```{r nmds}

library("vegan")
# tutorial: https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/nmds/

nmds <- metaMDS(comm = matrix[,-1],
                distance = "bray",
                engine = "monoMDS",
                weakties= FALSE, #do not allow that identical observations are plotted at different coordinates
                k = 3,
                maxit = 300,
                try = 40,
                trymax = 100)

nmds$stress

gof <- goodness(object = nmds)

plot(nmds, display = "sites", type = "none")
  points(nmds, display = "sites",
  cex = 2*gof/mean(gof))
  

plot(nmds$diss, nmds$dist)
plot(vegdist(matrix[,-1]), dist(scores(nmds, "sites")))

stressplot(object = nmds, lwd = 5)

nmds.point <- data.frame(nmds$points)
nmds.point$atoll <- matrix$atoll

nmds.point <- left_join(nmds.point, envs, by = "atoll")

ggplot(nmds.point, aes(x = MDS1, y = MDS2, colour = region)) +
  geom_point(size = 1.8, shape = 21, alpha = 0.9, stroke = 2.5) +
  theme_classic()

sp <- wascores(x = nmds$points, w = matrix[,-1], expand = TRUE) %>% as.data.frame()

ggplot(nmds.point, aes(x = MDS1, y = MDS2)) +
  geom_point(aes(colour = region),size = 1.8, shape = 21, alpha = 0.9, stroke = 2.5) +
  #geom_text(data = sp, label = rownames(sp)) +
  theme_classic()

```

```{r distance decay model}

library("betapart")

latlong <- left_join(matrix[,1], envs, by = "atoll") %>% as.data.frame()
latlong$long <- ifelse(latlong$long < 0, latlong$long+360, atoll.sum$long) # convert longitude

spat.dist <- dist(latlong[,c(3:4)], method = "euclidean")

dissim.atoll <- beta.pair.abund(matrix[,-1])$beta.bray.bal

plot(spat.dist, dissim.atoll, ylim = c(0,1), xlim = c(0, max(spat.dist)))

decay.exp <- decay.model(y = dissim.atoll, x = spat.dist,
                         y.type="dissimilarities", model.type="pow", perm=100)

```


```{r atoll contribution to individual species}

topatolls <- left_join(atollw, spec[,c(1:2)], by = "species")

topatolls$contr <- topatolls$nbirds.x/topatolls$nbirds.y

top5 <- topatolls %>% group_by(species) %>% arrange(desc(ratios)) %>% slice(1:3) %>% as.data.frame()

top5 %>% count(atoll, sort = TRUE)

``` 

